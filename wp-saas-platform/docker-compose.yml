version: "3.8"

services:

  # ===========================
  # Reverse Proxy
  # ===========================
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx:/etc/nginx/conf.d
    depends_on:
      - wp_tenant1
      - wp_tenant2

  # ===========================
  # WordPress Tenant 1
  # ===========================
  wp_tenant1:
    image: wordpress:php8.2
    env_file:
      - ./secrets/tenant1.env
    volumes:
      - ./tenants/tenant1/wp-content:/var/www/html/wp-content
    depends_on:
      - db_tenant1

  db_tenant1:
    image: mysql:8
    env_file:
      - ./secrets/tenant1.env
    volumes:
      - db_tenant1:/var/lib/mysql

  # ===========================
  # WordPress Tenant 2
  # ===========================
  wp_tenant2:
    image: wordpress:php8.2
    env_file:
      - ./secrets/tenant2.env
    volumes:
      - ./tenants/tenant2/wp-content:/var/www/html/wp-content
    depends_on:
      - db_tenant2

  db_tenant2:
    image: mysql:8
    env_file:
      - ./secrets/tenant2.env
    volumes:
      - db_tenant2:/var/lib/mysql

  # ===========================
  # Prometheus
  # ===========================
  prometheus:
    image: prom/prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  # ===========================
  # Grafana
  # ===========================
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"

  # ===========================
  # Jenkins
  # ===========================
  jenkins:
    image: jenkins/jenkins:lts
    user: root
    ports:
      - "8080:8080"
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock

  # ===========================
  # NGINX Exporter
  # ===========================
  nginx-exporter:
    image: bitnami/nginx-exporter
    environment:
      - NGINX_HOST=nginx
      - NGINX_PORT=80
      - NGINX_STATUS_PATH=/stub_status
    ports:
      - "9113:9113"
    depends_on:
      - nginx

volumes:
  db_tenant1:
  db_tenant2:
  jenkins_home:
